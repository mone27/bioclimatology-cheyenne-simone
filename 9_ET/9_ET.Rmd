---
title: "9th Protocol: Evapotranspiration"
author: "Cheyenne Rueda and Simone Massaro"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  pdf_document:
    toc: true
    number_sections: true
    includes:
      in_header: "../preamble.tex"
  html_notebook:
    number_sections: true
header-includes:
  - \fancyhead[L]{Evapotranspiration}
editor_options: 
  markdown: 
    wrap: 72
---

# Motivation

In this chapter we will focus on evapotranspiration. This term is well known in many environmental study fields, but, what is the most precise definition given to this term?

Evapotranspiration is referred according to the relationship of two other factors, such as the soil water evaporation and plant transpiration. The actual evapotranspiration is the one that is measured from these two factors mentioned before, considering changes and not ideal conditions in the meteorological conditions and the type of soil (Labedzki, 2011). In contrast, potential evapotranspiration is that one that occurs with ideal conditions such as abundance of water storage and meteorological conditions. Some differences between potantial and actual evapotranspiration are the infiltration capacity of soil, possible diseases, pH of soil and its fertility. 

Labedzki, L. (Ed.). (2011). Evapotranspiration. BoD–Books on Demand.



# Background

# Sensors and measuring principle





# Analysis

```{r, message=FALSE}
library(tidyverse)
library(lubridate)
et <- read_csv(
  "../Data_lectures/09_Turbulent_fluxes_I_ET/ET_data_forst_botanical_garden.csv",
  locale = locale(decimal_mark = ",")) %>% 
  rename(loc_id = replicates)
meteo <- read_csv("../Data_lectures/09_Turbulent_fluxes_I_ET/MeteoData_BotanicalGarden.csv")
```


```{r}
#' Potential evapotranspiration using Priestley-Taylor equation
#' input data is W/s internally converted to MJ/d
calc_pet <- function(T_air, Rn, G){
  g <- 0.067 # kPa K -1
  Rn <- Rn * 0.0864 # convert to MJ/day
  G <- G * 0.0864 # convert to MJ/day
  s <- ( 4098 * 0.6108 * exp((17.27 * T_air ) / (T_air +237.3) ) ) / ( T_air + 237.3 )^2
  pet <- 1.26 * s * (Rn - G) / (s + g)
  return(pet)
}
```


```{r}
#adding R_n and G to the 
(meteo_d <- meteo %>% 
  # Need to convert from W (J/s) to MJ/d, using a factor 0.0864
  # calculating with high frequency data and then averaging over the day
  mutate(PET = calc_pet(TA_degC, `NetRadiation_Wm-2`, `GroundHeatflux_Wm-2`)) %>% 
  group_by(Date = floor_date(Date, "day")) %>% 
  summarise(PET = mean(PET)))
```



```{r}
ggplot(meteo_d, aes(Date, PET)) +
  geom_line() +
  labs(y="PET (mm)")
```

```{r}
et %>% 
  left_join(meteo_d, by = c("date"= "Date")) %>% 
  drop_na() %>% 
  gather("type", "et", et_pan, PET) %>% 
  ggplot(aes(date, et, col=type)) +
  geom_line() +
  labs(y= "Evapotranspiration (mm)")
```

## Piché evaporimeters
```{r}
pich_d <- 3 #cm
pich_inn_d <- 0.9 # cm
# calc area exposed to air:
#2 times the area of the pare dish (two sides) - the area of glass
pich_dish_area <- 2 * (pi / 4 * pich_d ^ 2) - (pi / 4 * pich_inn_d ^ 2) # cm^2
pich_int_area <- (pi/4 * pich_inn_d ^2 ) # cm^2
```

```{r}
et <- et %>% 
  group_by(loc_id) %>% 
  mutate(
    # here the scale is the opposite, the lower the number the more the water
    diff_pich = pich_height_cm - lag(pich_height_cm),
    et_pan = lag(pan_height_mm) - pan_height_mm,
    # need to convert to right unit
    et_pich = diff_pich * pich_dish_area * pich_int_area / 10
  )
```


```{r}
et %>% 
  drop_na() %>% #removing first empty day
ggplot(aes(date)) +
  geom_line(aes(y=et_pan, col="pan"), size=.7) +
  geom_point(aes(y = et_pich, col=spot))
  
```
```{r}
ggplot(et, aes(spot, et_pich)) +
  geom_boxplot()
```



 ## PET WIP
 
```{r}
# this is like floor_date(x, "day"), but instead of changing the day at midnight
# it changes to the next day after the given hour
floor_time_day <- function(date, hour){
  date <- case_when(
    hour(date) <= hour ~ date, #keeping the same day
    hour(date) > hour ~ date + days(1) # going to next day
  )
  floor_date(date, "day")
}
```


```{r}
meteo %>% 
  group_by(Date = floor_date(Date, "day")) %>% 
  summarise(R_n_d = mean(`NetRadiation_Wm-2`) , G_d = mean(`GroundHeatflux_Wm-2`), T_air = mean(TA_degC)) %>% 
  mutate(
    PET = calc_pet(T_air, R_n_d, G_d)
  )
```


```{r}
#adding R_n and G to the 
meteo %>% 
  # Need to convert from W (J/s) to MJ/d, using a factor 0.0864
  # calculating with high frequency data and then averaging over the day
  group_by(Date = floor_date(Date, "hour")) %>% 
  summarise(across(everything(), mean)) %>% 
  mutate(PET = calc_pet(TA_degC, `NetRadiation_Wm-2`, `GroundHeatflux_Wm-2`)) %>% 
  group_by(Date = floor_date(Date, "day")) %>% 
  summarise(PET = mean(PET))
```

```{r}
#adding R_n and G to the 
meteo %>% 
  # Need to convert from W (J/s) to MJ/d, using a factor 0.0864
  # calculating with high frequency data and then averaging over the day
  group_by(Date = floor_date(Date, "30 min")) %>% 
  summarise(across(everything(), mean)) %>% 
  mutate(PET = calc_pet(TA_degC, `NetRadiation_Wm-2`, `GroundHeatflux_Wm-2`)) %>% 
  group_by(Date = floor_date(Date, "day")) %>% 
  summarise(PET = mean(PET))
```
```{r}
#adding R_n and G to the 
meteo %>% 
  # Need to convert from W (J/s) to MJ/d, using a factor 0.0864
  # calculating with high frequency data and then averaging over the day
  group_by(Date = floor_date(Date, "day")) %>% 
  summarise(across(everything(), mean)) %>% 
  mutate(PET = calc_pet(TA_degC, `NetRadiation_Wm-2`, `GroundHeatflux_Wm-2`)) %>% 
  group_by(Date = floor_date(Date, "day")) %>% 
  summarise(PET = mean(PET))
```

```{r}
et %>% 
  left_join(meteo_d, by = c("date"= "Date")) %>% 
  drop_na() %>% 
  gather("type", "et", et_pan, PET) %>% 
  ggplot(aes(date, et, fill=type)) +
  geom_bar(stat="identity", position="dodge") 
```



