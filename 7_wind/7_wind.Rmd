---
title: "7th Protocol: Wind"
author: "Cheyenne Rueda and Simone Massaro"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  bookdown::pdf_document2:
    toc: true
    number_sections: true
    includes:
      in_header: "../preamble.tex"
  html_notebook:
    number_sections: true
bibliography: ../bioclimatology-references.bib
header-includes:
  - \fancyhead[L]{Wind}
editor_options: 
  markdown: 
    wrap: 72
---
\newpage
# Motivation

# Background

# Sensors and measuring principle

averaging suing vector average [@grange_technical_2014]

\newpage
# Analysis

```{r, message=F}
library(tidyverse)
library(lubridate)
library(clifro) # for windrose
library(patchwork)
library(ggthemes)
theme_set(theme_bw()) # ggplot theme
```
```{r, message=F}
wind <- read_csv(here::here("Data_lectures/7_Wind/Winddata_Botanical_garden.csv")) %>% 
  drop_na() %>% 
  rename(WS_0.5m = WS_05m, wd=WD_deg)
```


```{r}
deg2rad <- function(deg) deg * pi / 180
rad2deg <- function(rad) rad * 180 / pi

# calculates the wind angular average over the provide input.
# intend to be used together with group_by and summarize
wind_dir_average <- function(wd){
  dir <- deg2rad(wd)
  # calc the vector components and then make the mean
  u <- cos(dir) %>% mean
  v <- sin(dir) %>% mean
  # convert back to a direction. Note atan2 uses y,x
  avg_dir <- atan2(v, u)
  # need to convert in 0 - 360 range
  avg_dir <- avg_dir %% (2*pi)
  return(rad2deg(avg_dir))
}

```

```{r}
# wind gathered
wind_g <- wind %>% 
  gather("height", "windspeed", WS_0.5m, WS_1m, WS_2m, WS_5m, WS_10m) %>% 
  # converts the height into a numeric value
  mutate(height = as.numeric(gsub(".*?([0-9]+).*", "\\1", height))) 

wind_1d<- wind %>%
  mutate(Date = floor_date(Date, unit = "1 day")) %>% 
  group_by(Date) %>%
  summarise(across(c(-wd), mean), wd = wind_dir_average(wd))

wind_g_1d <- wind_1d %>% 
  gather("height", "windspeed", WS_0.5m, WS_1m, WS_2m, WS_5m, WS_10m) %>% 
  # converts the height into a numeric value
  mutate(height = as.numeric(gsub(".*?([0-9\\.]+).*", "\\1", height))) 
```

## Wind averages

*Calculate 1 hour averages of 10 minute mean wind speed and direction
data.*

```{r}
wind_1h <- wind %>%
  group_by(round_date(Date, unit = "1 hour")) %>%
  summarise(across(-wd, mean), wd = wind_dir_average(wd))
```

```{r, wd-avg, fig.cap="Comparison of wind direction original data (10 mins) and hourly average. Data from botanical gardern 15th-17th January 2021."}
wind %>%
  filter(between(Date, as_datetime("2021-01-15") , as_datetime("2021-01-17"))) %>%
ggplot()+
  geom_point(aes(Date, wd, colour="10 mins"), size=.8) +
  geom_line(aes(Date, wd, colour="1 hour"),
            data=filter(wind_1h, between(Date, as_datetime("2021-01-15"),
                                               as_datetime("2021-01-17")))) +
  labs(y="Wind direction", colour="") +
  scale_y_continuous(breaks = c(0, 90, 180, 270, 360),
                     labels = c('N (0°)', 'E (90°)', 'S(180°)',
                                'W(270°)', 'N (360°)'), limits = c(-10, 370))
```

The wind speed and direction have been averaged at 1 hour. Vectorial average has been used for wind direction.
In figure \@ref(fig:wd-avg) the average direction is compared with the original data.
Between the 15th and the 16th of January there are some data points with a wind direction close to 0, but the average is around 350.


\newpage

## Wind speed and height

*How does the wind speed change with height? Characterize the wind
pattern in different heights at the botanical garden*


```{r, ws-diff-height, fig.cap="Time series of wind speed at different heigth. (a) is a summer month (15th Jan 2020 - 15th Feb 2020). (b) is a winter month(15th Jun 2020 - 15th Jul 2020). Data from botanical garden."}
## plotting the same thing using gather
(wind_g_1d %>%
  #just one month otherwise the plot is too compressed
  filter(between(Date, as_datetime("2020-01-15") , as_datetime("2020-02-15") )) %>% 
  mutate(height = fct_reorder(as_factor(height), sort(height, decreasing = T))) %>% 
  ggplot(aes(Date, windspeed, col=height))+
  geom_line() +
  scale_color_colorblind() +
  labs(y="Windspeed (m/s)", colour="Height (m)", title="(a) Winter month")) /
(wind_g_1d %>%
  #just one month otherwise the plot is too compressed
  filter(between(Date, as_datetime("2020-06-15") , as_datetime("2020-07-15") )) %>% 
  mutate(height = fct_reorder(as_factor(height), sort(height, decreasing = T))) %>% 
  ggplot(aes(Date, windspeed, col=height))+
  geom_line() +
  scale_color_colorblind() +
  labs(y="Windspeed (m/s)", colour="Height (m)", title="(b) Summer month")) +
plot_layout(guide="collect")

```

In Figure \@ref(fig:ws-diff-height) ..
As it is possible to appreciate in the graph, wind speed gets faster at 10m height. This makes sense when having in mind the vertical wind profile graph that increases with height. 


```{r}
wind_prof <- wind_g_1d %>% 
  group_by(height) %>% 
  summarize(windspeed=mean(windspeed))
#### fit logarithmic wind profile to data and estimate the parameters u*, z0 and d ####
# initial values
u_star_start <- 0.1
d_start <- 0.3
z0_start <- 0.05

log_prof_model <- nls(windspeed ~u_star/0.4*(log((height - d)) - log(z0)), 
                 start = list(u_star=u_star_start,              
                              d=d_start,              
                              z0=z0_start),                     
                 na.action = na.exclude, data=wind_prof)
wind_prof <- mutate( wind_prof,
  pred_ws = predict(log_prof_model))
```


```{r, ws_boxplot, fig.cap=""}
wind_g_1d %>%
  ggplot() +
  geom_boxplot(aes(windspeed, height, group=height)) +
  geom_line(aes(x=pred_ws, y=height, colour="Fitted log profile"),  data = wind_prof) +
  geom_point(aes(x=pred_ws, y=height, colour="Fitted log profile"), data = wind_prof, )
```

Boxplot and fitted curve

\newpage

## Windspeed over year

*How does the wind speed varies over the year and what can explain the
variability?*

```{r}
wind_q <- wind %>% 
  mutate(quarter = quarter(Date) %>%
           as_factor)
windrose(wind_q$WS_10m, wind_q$wd, wind_q$quarter, n_col= 2, col_pal="YlGnBu",
         ggtheme = "bw")
```


\newpage
```{r, ws_year, fig.cap="Daily averages of wind speed at 10 meters. Data from forest botanical garden January 2020 - February 2021."}
ggplot(wind_1d, aes(Date, WS_10m)) +
  geom_line() +
  labs(y="Wind speed (m/s)")
```

During the spring and winter the wind is stronger. In summer daily average oscillates around 1.5 m/s


The graphs displays the variation of the wind speed along year. It is faster from end of december to beginning of april. During summer the mean wind speed is lower but some days it gets faster than others. This variability is originated depending on when the wind is coming from.


\newpage

```{r}
# data frame with months start and end to draw background
months <- map_df(1:14, function(n_mon){
  start <- as_datetime("2020-01-01")
  # offset to the correct month start
  month(start) <- month(start) + n_mon - 1
  end <- start
  # adding one month to get to the end and removing one day
  month(end) <- month(end) + 1
  day(end) <- day(end) - 1
  tibble(start = start, end = end,
         month= month(start, label = T), quarter= quarter(start))
} )
```


```{r, wd-year, fig.cap="Weekly average of wind directions for the year. The distance from the center and the different background indicates the date, while the position in the circle the wind direction. Data from forest botanical garden January 2020 - February 2021."}
wind %>%
  group_by(round_date(Date, unit = "1 weeks")) %>%
  summarise(across(c(matches("WS"), Date), mean), wd = wind_dir_average(wd)) %>% 
  ggplot() + 
  geom_rect( #add months in the background to be able to read the figure
    aes(xmin = start, xmax = end, fill = month), 
    ymin = -Inf, ymax = Inf, alpha = 0.6, 
    data = months
  ) +
  scale_fill_brewer(palette = "Set3") +
  geom_point(aes(Date, wd)) +
  coord_polar(theta="y") +
  labs(y="Wind direction", fill="Month") +
    scale_y_continuous(breaks = c(90, 180, 270, 360),
                     labels = c('E', 'S', 'W', 'N' ), limits=c(0, 360))
```



# References