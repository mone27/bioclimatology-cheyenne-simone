---
title: "R Notebook"
output:
  html_notebook: default
  html_document:
    df_print: paged
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include=F}
library(tidyverse)
library(lubridate)
library(tsibble)
library(scales)
#library(janitor)
```

## Longwave radiation

## 1.1 Motivation

~~Unlike shorwave radiation, longwave radiation is emitted by every body
that has a temperature~~. Longwave radiation is a less ~~intense~~ due to its
lower wavelength frequency than shortwave radiation. Emitted longwave
radiation by earth surface is the way for the planet to cool down itself
from shortwave radiation coming directly from the sun.

Following, a more simple way to explain longwave radiation. All bodies
emit electromagnetic radiation and this causes a rise of the temperature
range of the earth surface ??. This leads to emission in the long wavelength
range. This is how longwave radiation is constantly present in the
ecosystems and represents one of the avenues to exchange energy.

~~The process known as~~ global warming is directly concerned with longwave
radiation. Global warming is caused by a increase of concentration of
green house, which capture part of the longwave radiation emitted from the earth
and remitted to towards the earth,
thus increasing the amount of radiation reaching the surface of the earth, which increase the earth temperature.

## 1.2 Background
~~describe the most important background needed to
fulfill the excercises, i.e. for short wave radiation, what is
radiation?, which variables exist and what are they?, which units do the
variables have?, which radiation laws exist and what is their meening?,
and what are transport mechanisms (transmission, absorption,...) - list
necessary equations - maybe include calibration coefficients for
reproducibility and when necessary~~

Longwave radiation is emitted by all bodies on the Earth, with the total intensity depending on the temperature as described by the *Steffan-Boltzman law*

$$E = \varepsilon \sigma T^4$$
Where:

- $E$ is the radiation intensity in $W/m^2$
- $\varepsilon$ an adimensional coefficient that represents the emissivity of the body.
This depends on the material, a perfect black body has a $\varepsilon$ of $1$, while other materials have a lower emissivity
- $\sigma$ is the Steffan-Boltzman constant $5.67 \times 10^{-8} W m^{-2} K^{-4}$
- $T$ is the body temperature in $K$

The longwave radiation behaves like the shortwave radiation, being scattered by the canopy and the atmosphere.


## 1.3 Sensors and measuring principle

Longwave radiation is an important flux to understand how climatology
works in earth and understand processes such as global. Thus, some
instruments have been developed as well to measure longwave radiation.
The pyrgeometer measures this type of radiation from the atmosphere and
the Earth's surface. This device is based on a sensitive range with
infrared radiation between of 4.5 and 40 micrometer. It includes a
thermal detector (64 thermocouple thermopile) based on giving a voltage
output that then is needed to convert into radiative flux of energy
units (W m-2). The way it works is basic, calculating the difference
between the longwave radiation coming from the atmosphere and the
longwave produced by the sensor. This is represented by the next
equation:

$$ A= Unet/S + sigma * Tb^4 $$ $$ Unet/S = Ua/S + Ubody/S $$ Another
devide that allows to measure longwave radiation is the pyrometer. The
pyrometer measures longwave radiation and converts it into a temperature
based on the Stefan Boltzmann principle). Besides, it exists other types
of sensor based on the measurement of net radiation. One of them is
known as CNR4, based on 4 components (G, Rsw, A, E) which gives an
output value for each of these. The other instrument that can be used
for the same application is NR-Lite2. It is based on a thermopile that
mesures net radiation (G+A) in the upper side, whether in the other side
it is measuring the net outgoing radiation (Rsw+E). These last two are
similar instruments, but the last one (NR-Lite2) only gives one value as
output in shape of voltage which is proportional to the Rn or net
radiation.

## 1.4 Analysis

```{r, message=FALSE}
rad <- read_csv("../Data_lectures/2_Longwave_radiation/LW_SW_TSoil_BotGarten.csv")
names(rad) <- c("datetime", "t_sens", "sw_in", "sw_out", "lw_in_sens", "lw_out_sens", "t_soil")
```

```{r}
# Utlitity funcs
sigma <- 5.67e-8 

lw2temp <- function(lw) (lw/ sigma)^(1/4)
temp2lw <- function(temp)  return (sigma * temp^4)

c2k <- function(c) c + 273.15
k2c <- function(k) k - 273.15
```

```{r}
#calculate from input data the real lw and the soil/surface temperature
rad <- rad %>%
  drop_na() %>%
  mutate(
    lw_sens = temp2lw(c2k(t_sens)),
    lw_in = lw_in_sens + lw_sens,
    lw_out = lw_out_sens + lw_sens,
    t_sky = lw2temp(lw_in) %>% k2c,
    t_surface = lw2temp(lw_out) %>% k2c,
    net_rad = lw_in - lw_out + sw_in - sw_out,
    net_sw = sw_in - sw_out,
    net_lw = lw_in - lw_out
  )
```

```{r}
# for making aggregation easier we are going to consider data only for one calendar year
rad <- rad %>%
  filter(datetime < as_datetime("2020-12-31"))
```

```{r}
# weekly average data
rad_w <- rad %>% 
  as_tsibble(index = datetime) %>%
  index_by(week = ~ yearweek(.)) %>%
  summarise_all(mean, na.rm = TRUE)
```

```{r}
# daily average data
rad_d <- rad %>%
  mutate(yday = yday(datetime)) %>%
  group_by(yday) %>%
  summarize_all(mean, na.rm = TRUE)
```

#### surface and sky temperature

*Derive the sky and surface temperature from the longwave radiation
components. How do they differ and why? Discuss! During which periods of
the year sky and surface temperature differ the most and the less?*

The two temperature are analyzed at different timescales

```{r}
rad_w %>%
  gather(key="type", value="temp", t_sky, t_surface) %>%
ggplot(aes(x=datetime, y=temp, colour=type)) +
  geom_line() +
  labs(caption="Weekly average", y="Temperature (째C)", x="Time",
       title="Sky and Surface temperatures over the year")
```

```{r}
rad_d %>%
  gather(key="type", value="temp", t_sky, t_surface) %>%
ggplot(aes(x=datetime, y=temp, colour=type)) +
  geom_line()  +
  labs(caption="Daily average", y="Temperature (째C)", x="Time",
       title="Sky and Surface temperatures over the year")
```
The sky temperatures is always lower than the surface one. The surface
temp ranges from `r round(min(rad_d$t_surface, na.rm=T))` C to
`r round(max(rad_d$t_surface, na.rm=T))` C, while the sky temperature has
a bigger range from `r round(min(rad_d$t_sky, na.rm=T))` C to
`r round(max(rad_d$t_sky, na.rm=T))` C. The temperature of the sky mainly
depends on the cloud cover and the temperature of the air.

```{r}
rad %>%
  filter( month(datetime) == 7 ) %>%
  gather(key="type", value="temp", t_sky, t_surface) %>%
ggplot(aes(x=datetime, y=temp, colour=type)) +
  geom_line()  +
  labs(caption="Month of July (10 mins data)", y="Temperature (째C)", x="Time",
       title="Sky and Surface temperatures over one month")
```

```{r}
filter(rad, between(datetime, as_datetime("2020-07-03"), as_datetime("2020-07-12"))) %>%
  gather(key="type", value="temp", t_sky, t_surface) %>%
ggplot(aes(x=datetime, y=temp, colour=type)) +
  geom_line()  +
  labs(caption="3-12 July (10 mins data)", y="Temperature (째C)", x="Time",
       title="Sky and Surface temperatures over one week")
```

The surface temperature has a clear day cycle, while the sky temperature has little or no day pattern.
Moreover, it can be clearly seen how cloudy days (eg. 9th of July) there is an high sky temperature, but a low surface temperature.
Conversely on sunny days (eg. 7th of July) the surface temperature is higher, but the sky temperature is low.


#### Net radiation

*Calculate the net radiation over the meadow in the forest botanical
garden and plot the four components. How do the four components change
over the season and why? Which unexpected results you found? Discuss!*

```{r}
rad_w %>%
  gather(key="type", value="radiation", net_rad, lw_in, lw_out, sw_in, sw_out,
         factor_key = T) %>%
ggplot() +
  geom_line(aes(x=datetime, y=radiation, colour=type)) +
  geom_line(aes(x=datetime, y=net_rad), data=rad_w, size=1.2,
            colour=hue_pal()(1)) +
  labs(title="Net radiation with components over ", y="Radiation (W m-2)",
       x="Time", caption = "Weekly average")
```

The net radiation has a yearly cycle. During the summer it has a relatively constant value at around $100 W/m^2$ to then decrease and reach slightly negative values in January.
The compoment with the 

#### change emissity in the sensor

we tried to change the emissivity in the settings of the infrared
thermometer, but due to some errors in the field data measurements we
generated this data using the formula.

```{r}
t_0 <- 19 # temperature with emissivity 1
rad_0 <- c2k(t_0) %>% temp2lw # connected radiation 

temps <- tibble(
  em = seq(1, .7, -.05),
  t = (rad_0 / (em * sigma))^(1/4) 
) 
```

```{r}
ggplot(temps, aes(em, t)) +
  geom_line() +
  scale_x_reverse() +
  labs(x="Emissivity", y="Temperature", title="Different temperatures with different emissivity")
```
