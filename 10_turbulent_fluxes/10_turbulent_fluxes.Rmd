---
title: "10th Protocol: Turbulent fluxes"
author: "Cheyenne Rueda and Simone Massaro"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  bookdown::pdf_document2:
    toc: true
    number_sections: true
    includes:
      in_header: "../preamble.tex"
  html_notebook:
    number_sections: true
header-includes:
  - \fancyhead[L]{Turbulent fluxes}
editor_options: 
  markdown: 
    wrap: 72
---
# Turbulent fluxes

## Motivation

## Background

## Sensors and measuring principle

## Analysis

1.
Calculate the half hourly latent heat flux, the net ecosystem exchange of CO 2 and the sensible heat flux from the high frequency turbulence data. 
```{r}
library(tidyverse)
library(cowplot) #multiple plots
library(naniar) # to replace missing values 
library(ggthemes)
theme_set(theme_bw())
```




## Respiration chambers

```{r}
co2 <- read_csv2(here::here("Data_lectures/soilCO2flux.csv"),
                 col_names=c("time", "co2", "chamber"), skip=1)
# loading some data directly from in the R code for simplicity
p_a <- 989.5 #hPa - air pressure
T_a <- 16 + 273.15 # Â°C - air temperature
diam <- 0.152 # m - radius of chamber
top_height <- 0.138 # m - height of top part of the chamber (same for everything)

# area 
area <- pi / 4 *diam^2

# chamber specific data
chambers <- tribble(
  ~"Tsoil",~"chamber",~"height",
  17,	  1, 0.16225,		
  17,	  2, 0.17,
  16.8,	3, 0.1495,
  16.7,	4, 0.154,
  17.2,	5, 0.159
) %>% 
  mutate(
    Volume= pi / 4 * diam^ 2 * (height+top_height))
# Molar Gas Constant
R <- 8.314 # J/mol K
```

```{r}
# Molar volume 
M <- p_a / (R*T_a)

co2flux <- co2 %>%
  # Adding chamber information
  left_join(chambers) %>% 
  group_by(chamber) %>% 
  mutate(
    dt = time - lag(time),
    dc = co2 - lag(co2),
    Fc = (dc/dt)*(M*Volume/area),
    # for plotting
    chamber = as.factor(chamber)
  )

co2flux
```


```{r}
ggplot(co2flux, aes(time, co2, col=chamber)) +
  geom_line()
```

```{r}
ggplot(co2flux, aes(time, dt/dc, col=chamber)) +
  geom_line()
```
```{r}
ggplot(co2flux, aes(time, Fc, col=chamber)) +
  geom_line()
```

```{r}
ggplot(co2flux, aes(chamber, Fc)) +
  geom_boxplot()
```





