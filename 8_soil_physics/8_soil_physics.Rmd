---
title: "8th Protocol: Soil physics"
author: "Cheyenne Rueda and Simone Massaro"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  bookdown::pdf_document2:
    toc: true
    number_sections: true
    includes:
      in_header: "../preamble.tex"
  html_notebook:
    number_sections: true
bibliography: ../bioclimatology-references.bib
header-includes:
  - \fancyhead[L]{Soil physics}
editor_options: 
  markdown: 
    wrap: 72
---
# Motivation

Soil is the 

# Background
# Sensors and measuring principle
```{r, message=F}
library(tidyverse)
library(lubridate)
```
```{r, message=F}
soil <- read_csv("../Data_lectures/8_Soil_physics/Soil_temperature_bot_garden.csv")
```

```{r}
head(soil)
```
```{r}
soil_g <- soil %>% 
  gather("depth", "T_soil", starts_with("Tsoil")) %>% 
  mutate(depth = str_extract(depth, "\\d+"))
```


```{r}
soil_g
```

```{r, fig.cap="Soil temperature at different depths for one day. Data from 5th of May 2020, forest botanical garden."}
soil_g %>% 
  # last day available to bet as close as possible to summer.
  # Number 126 was got as `max(yday(soil$Date))`
  filter(yday(Date)==126) %>% 
  ggplot(aes(Date, T_soil, col=as_factor(depth))) +
  geom_line() +
  labs(y="Temperature soil (°C)", colour="Depth (cm)")
```
```{r}
range(yday(soil$Date))
```

1. Calculate the soil heat flux in 5cm detph and the soil storage flux for the soil layer above from the soil temperature profile. Assume a thermal conductivity $$k=3.5 W/m*K$$ and a heat capacity $$c_p=3.5*10^6 J/m^3*K$$. Compare your calculations with direct measurements of the soil heat flux. How do thermal conductivity and heat capacity affect your results?


```{r}
soil$prev_temp <- NA_real_
soil$prev_temp[2:nrow(soil)] <- soil$Tsoil_5cm_degC[1:(nrow(soil)-1)]
```
```{r}

c2k <- function(c) c + 273.15
k2c <- function(k) k - 273.15


#using as a reference the soil at 5 cm
d_T_space <- soil$TSoil_2cm_degC - soil$Tsoil_5cm_degC
d_z <- - 0.03 # m

d_T_time <- c2k(lag(soil$Tsoil_5cm_degC)) - c2k(soil$Tsoil_5cm_degC)

d_t <- 600 # seconds manually calculated from the dataset

Cv <- 3.5e6 # J m⁻³ K⁻¹
k <- 3.5 # W m⁻¹ K⁻¹
```

```{r}
flux_time <- d_z * d_T_time * Cv / d_t # W m-2 

flux_space<- - k * d_T_space / d_z 
```

```{r}
soil_flux <- flux_time + flux_space
```

```{r}
soil <- mutate(soil,
               soil_flux = flux_time + flux_space)
```

```{r}
soil %>% 
  filter(week(Date)==15) %>% 
  ggplot(aes(Date, soil_flux)) +
  geom_line()+
  geom_line(aes(y=SoilHeatFlux_Wm2, col="measured heat flux")) +
  labs(y="Soil heat flux (W/m2)")
```
```{r}

```


```{r}
plot(soil_flux, soil$SoilHeatFlux_Wm2)
```


```{r}
plot(soil_flux, type = "l")
lines(soil$SoilHeatFlux_Wm2, col="red")
```

```{r}
cor(soil_flux, soil$SoilHeatFlux_Wm2, use="complete.obs")
```

```{r}
plot(flux_space, type = "l")
 lines(soil$SoilHeatFlux_Wm2, col="red")
```


```{r}
hist(soil$SoilHeatFlux_Wm2)
```

```{r}
hist(soil_flux)
```

```{r}
hist(flux_space)
```
```{r}
hist(flux_time)
```







