---
title: "8th Protocol: Soil physics"
author: "Cheyenne Rueda and Simone Massaro"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  bookdown::pdf_document2:
    toc: true
    number_sections: true
    includes:
      in_header: "../preamble.tex"
  html_notebook:
    number_sections: true
bibliography: ../bioclimatology-references.bib
header-includes:
  - \fancyhead[L]{Soil physics}
editor_options: 
  markdown: 
    wrap: 72
---
# Motivation

During the previous protocols, it has been described that earth is formed by different atmospheric layers. Well, is not only about these but also about the ones that are found more at the land surface. Soil is the first layer found when land surface is reached. It consists on the middle face between the lithosphere and the atmosphere. Thus, soil is related with other factors, such as biology and hydrology. Ecosystems are established on the soil, and soil is shaping them as the main source of resources for the natural habitats to expand (Lal & Shukla, 2004). In this report, the main focus is partly on how heat soil's storage and hydrology processes.


Lal, R., & Shukla, M. K. (2004). Principles of soil physics. CRC Press.

# Background

Soil temperature and soil water content are both factors that alters soil respiration rate. Soil respiration is a process measured by $$CO_2 \frac{micromol} {m^2*s} $$ (Brechet et al, 2018).
Soil is an important environmental variable partly in charge of an efficient ecosystem activity. Soil moisture drives changes in stomata conductance, photosynthesis rate and energy partitioning. Hence, water potential is the main reason of the movement of water through osmosis, gravity and air pressure. 

Soil water potential is constitute by its matrix potential (adhesive force water-soil particles), osmotic potential (gradient of solute's [C]), pressure potential(pressure of air) and gravitational potential (mass of water). 
REgarding water potential, other factors from the soil are very important. These are its particles size, pore volume or pore size. This will variate depending on the type of soil at each moment, being sandy the soil with the thickest particles size with bigger pores and thus, less water retention capacity.


Soil characteristics can be approach by different perspectives, such as the surgace energy fluxes and hydrology. The first one regarding on the direct solar incoming radiation, reflected radiation and absorbed radiation. The second one, regards on the precipitation, evaporation, infiltration, surface runoff. Each of these cause different processes on soil structure. 

Going deeper into how energy fluxes affect the soil, the ground heat flux capacity will be introduce. This process is based on Fourier's which describes the heat transfer in soil with the conduction of its components, from higher to lower temperatures. In fact, this law includes paramters such as: 
$$k: thermal conductivity (W/m*K)$$, $$T: temeprature in K$$ and $$z: depth (m)$$. 

The variation in soil temperature along a period of time depends in depth and the heat flux going inside it, thus: 
$$ T/t = 1/C_v [...]$$ $$C_v: heatcapacity (J /m^3*K)$$ 
The temperature along soil's profile might variates when is day or night. During day, the temperature of soil is higher than the temperature of air and thus starts to get more equally until night is set. After this occurs, the temperature of air is higher than the soil temperature, with this peak being more distinguish during midnight. 






# Sensors and measuring principle

# Analysis
```{r, message=F}
library(tidyverse)
library(lubridate)
library(FME)
```
```{r, message=F}
soil <- read_csv("../Data_lectures/8_Soil_physics/Soil_temperature_bot_garden.csv")
```

```{r}
head(soil)
```
```{r}
soil_g <- soil %>% 
  gather("depth", "T_soil", starts_with("Tsoil")) %>% 
  mutate(depth = str_extract(depth, "\\d+"))
```


```{r}
soil_g
```

```{r, fig.cap="Soil temperature at different depths for one day. Data from 5th of May 2020, forest botanical garden."}
soil_g %>% 
  # last day available to bet as close as possible to summer.
  # Number 126 was got as `max(yday(soil$Date))`
  filter(yday(Date)==126) %>% 
  ggplot(aes(Date, T_soil, col=as_factor(depth))) +
  geom_line() +
  labs(y="Temperature soil (Â°C)", colour="Depth (cm)")
```

1. Calculate the soil heat flux in 5cm detph and the soil storage flux for the soil layer above from the soil temperature profile. Assume a thermal conductivity $$k=3.5 W/m*K$$ and a heat capacity $$c_p=3.5*10^6 J/m^3*K$$. Compare your calculations with direct measurements of the soil heat flux. How do thermal conductivity and heat capacity affect your results?

#```{r}
#soil$prev_temp <- NA_real_
#soil$prev_temp[2:nrow(soil)] <- soil$Tsoil_5cm_degC[1:(nrow(soil)-1)]
#```


Now, we proceed with the calculation of soil heat flux at 5cm depth, suing the temperature difference between 5 and 10 cm in soil. Also, soil heat storage will be calculated. 
```{r}

c2k <- function(c) c + 273.15
k2c <- function(k) k - 273.15

#using as a reference the soil at 5 cm
d_T_space <- soil$Tsoil_5cm_degC - soil$Tsoil_10cm_degC
d_z_space <- - 0.05 # m


d_z_time <- - 0.03 # m 
d_T_time <- c2k(lag(soil$Tsoil_5cm_degC)) - c2k(soil$Tsoil_5cm_degC)
d_t <- 600 # seconds manually calculated from the dataset (10 min) 

Cv <- 3.5e6 # J m-3 K-1
k <- 3.5 # W m-1 K-1
```

```{r}
soil <- soil %>% 
  mutate(
    flux_time = d_z_time * d_T_time * Cv / d_t, # W m-2 
    flux_space = - k * (d_T_space / d_z_space), # W m-2 
    soil_flux = flux_time + flux_space)
```



```{r, soil-flux, fig.cap="Comparison between heat flux measured (red) and calculated (black).Data collected from the soil's temperature of the  botanical garden on the 8th-15th April 2021."}
soil %>% 
  filter(week(Date)==15) %>% 
  ggplot(aes(Date, soil_flux)) +
  geom_line(aes(col="Calculated"))+
  geom_line(aes(y=SoilHeatFlux_Wm2, col="Measured")) +
  scale_colour_manual(values = c("black", "#F8766D")) +
  labs(y="Soil heat flux (W/m2)", col="Type heat flux")
```

The heat flux measured at 5cm depth is compared with the one calculated in Figure \@ref(fig:soil-flux).
The two fluxes are overall comparable, with the exception of the  

### Influence of Cv and K

```{r}
calc_soil_flux <- function(pars){
  d_T_space <- soil$Tsoil_5cm_degC - soil$Tsoil_10cm_degC
  d_z_space <- - 0.05 # m
  
  
  d_z_time <- - 0.03 # m 
  d_T_time <- c2k(lag(soil$Tsoil_5cm_degC)) - c2k(soil$Tsoil_5cm_degC)
  flux_time = d_z_time * d_T_time * pars$Cv / d_t # W m-2
  flux_space = - pars$k * (d_T_space / d_z_space) # W m-2
  
  soil_flux <-  flux_time + flux_space
  tibble(soil_flux=soil_flux[-1]) #remove first row that is NA
}
```

```{r}
pars <- list(Cv = 3.6e6, k=3.5)
sens <- sensFun(calc_soil_flux, pars, map=NULL)

summary(sens) %>% 
  knitr::kable(
    booktabs = TRUE,
    digits = 2,
    caption = 'Flux sensitivity'
  )
```

A local sensitivity analysis [@soetaert_inverse_2010] was made for the two parameters used in the flux calculation: thermal conductivity ($k$) and heat capacity ($C_v$). The thermal conductivity has the biggest influence on the the overall flux.

\newline
# References




