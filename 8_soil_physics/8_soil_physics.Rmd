---
title: "8th Protocol: Soil physics"
author: "Cheyenne Rueda and Simone Massaro"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  bookdown::pdf_document2:
    toc: true
    number_sections: true
    includes:
      in_header: "../preamble.tex"
  html_notebook:
    number_sections: true
bibliography: ../bioclimatology-references.bib
header-includes:
  - \fancyhead[L]{Soil physics}
editor_options: 
  markdown: 
    wrap: 72
---
# Motivation

Soil is the 

# Background

Soil temperature and soil water content are both factors that alters soil respiration rate. Soil respiration is a process measured by $$CO_2 \frac{micromol} {m^2*s} $$ (Brechet et al, 2018).
Soil is an important environmental variable partly in charge of an efficient ecosystem activity. Soil moisture drives changes in stomata conductance, photosynthesis rate and energy partitioning. Hence, water potential is the main reason of the movement of water through osmosis, gravity and air pressure. 

Soil water potential is constitute by its matrix potential (adhesive force water-soil particles), osmotic potential (gradient of solute's [C]), pressure potential(pressure of air) and gravitational potential (mass of water). 
REgarding water potential, other factors from the soil are very important. These are its particles size, pore volume or pore size. This will variate depending on the type of soil at each moment, being sandy the soil with the thickest particles size with bigger pores and thus, less water retention capacity.


Soil characteristics can be approach by different perspectives, such as the surgace energy fluxes and hydrology. The first one regarding on the direct solar incoming radiation, reflected radiation and absorbed radiation. The second one, regards on the precipitation, evaporation, infiltration, surface runoff. Each of these cause different processes on soil structure. 

Going deeper into how energy fluxes affect the soil, the ground heat flux capacity will be introduce. This process is based on Fourier's which describes the heat transfer in soil with the conduction of its components, from higher to lower temperatures. In fact, this law includes paramters such as: 
$$k: thermal conductivity (W/m*K)$$, $$T: temeprature in K$$ and $$z: depth (m)$$. 

The variation in soil temperature along a period of time depends in depth and the heat flux going inside it, thus: 
$$ T/t = 1/C_v [...]$$ $$C_v: heatcapacity (J /m^3*K)$$ 
The temperature along soil's profile might variates when is day or night. During day, the temperature of soil is higher than the temperature of air and thus starts to get more equally until night is set. After this occurs, the temperature of air is higher than the soil temperature, with this peak being more distinguish during midnight. 






# Sensors and measuring principle
```{r, message=F}
library(tidyverse)
library(lubridate)
```
```{r, message=F}
soil <- read_csv("../Data_lectures/8_Soil_physics/Soil_temperature_bot_garden.csv")
```

```{r}
head(soil)
```
```{r}
soil_g <- soil %>% 
  gather("depth", "T_soil", starts_with("Tsoil")) %>% 
  mutate(depth = str_extract(depth, "\\d+"))
```


```{r}
soil_g
```

```{r, fig.cap="Soil temperature at different depths for one day. Data from 5th of May 2020, forest botanical garden."}
soil_g %>% 
  # last day available to bet as close as possible to summer.
  # Number 126 was got as `max(yday(soil$Date))`
  filter(yday(Date)==126) %>% 
  ggplot(aes(Date, T_soil, col=as_factor(depth))) +
  geom_line() +
  labs(y="Temperature soil (°C)", colour="Depth (cm)")
```
<<<<<<< Updated upstream
```{r}
range(yday(soil$Date))
```
=======

>>>>>>> Stashed changes

1. Calculate the soil heat flux in 5cm detph and the soil storage flux for the soil layer above from the soil temperature profile. Assume a thermal conductivity $$k=3.5 W/m*K$$ and a heat capacity $$c_p=3.5*10^6 J/m^3*K$$. Compare your calculations with direct measurements of the soil heat flux. How do thermal conductivity and heat capacity affect your results?

```{r}

```

```{r}
soil$prev_temp <- NA_real_
soil$prev_temp[2:nrow(soil)] <- soil$Tsoil_5cm_degC[1:(nrow(soil)-1)]
```
```{r}
#using as a reference the soil at 5 cm
d_T_space <- soil$TSoil_2cm_degC - soil$Tsoil_5cm_degC
d_z <- - 0.03 # m = 3 cm

d_T_time <- lag(soil$Tsoil_5cm_degC) - soil$Tsoil_5cm_degC

d_t <- 10 # seconds manually calculated from the dataset

Cv <- 3.5e6 # J m⁻³ K⁻¹
k <- 3.5 # W m⁻¹ K⁻¹
```

```{r}
flux_time <- d_z * d_T_time * Cv / d_t # W m-2 
```




```{r}
hist(d_T_time)
```


```{r}
flux_space<- - k * d_T_space / d_z 
```

```{r}
soil_flux <- flux_time + flux_space
```


```{r}
plot(soil_flux, soil$SoilHeatFlux_Wm2)
```


```{r}
plot(soil_flux, type = "l")
lines(soil$SoilHeatFlux_Wm2, col="red")
```

```{r}
cor(soil_flux, soil$SoilHeatFlux_Wm2, use="complete.obs")
```

```{r}
plot(flux_space, type = "l")
 lines(soil$SoilHeatFlux_Wm2, col="red")
```


```{r}
hist(soil$SoilHeatFlux_Wm2)
```

```{r}
hist(soil_flux)
```

```{r}
hist(flux_space)
```
```{r}
hist(flux_time)
```


```{r}
ggplot() +
  geom_line(aes(x = now(soi_flux), y=soil_flux, col="soil")) +
  geom_line(aes(y=soil$SoilHeatFlux_Wm2, col="heat_flux"))
```




